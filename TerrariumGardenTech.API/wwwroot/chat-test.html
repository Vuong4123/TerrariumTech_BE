`<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Real-time Test - SignalR</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .users-panel {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }

        .users-header {
            background: #007bff;
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
        }

        .users-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .user-item {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:hover {
            background-color: #e9ecef;
        }

        .user-item.active {
            background-color: #cce5ff;
            border-left: 4px solid #007bff;
        }

        .user-info h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #333;
        }

        .user-info p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .user-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .user-status.active {
            background-color: #d4edda;
            color: #155724;
        }

        .user-status.inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        .chat-panel {
            display: flex;
            flex-direction: column;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .chat-container {
            border: 1px solid #ddd;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fafafa;
            border-radius: 5px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }
        
        .message.own {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.other {
            background-color: #e9ecef;
            color: #333;
        }
        
        .message-info {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        input, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        input[type="text"] {
            flex: 1;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            min-width: 100px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            font-style: italic;
            color: #666;
            padding: 5px 15px;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Chat Real-time Test - SignalR</h1>
        
        <!-- Connection Status -->
        <div id="status" class="status disconnected">
            ‚ùå Ch∆∞a k·∫øt n·ªëi
        </div>
        
        <!-- Error Messages -->
        <div id="error" class="error" style="display: none;"></div>
        
        <!-- Connection Setup -->
        <div class="input-group">
            <input type="text" id="jwtToken" placeholder="Nh·∫≠p JWT Token..." />
            <button id="connectBtn" onclick="connect()">K·∫øt n·ªëi</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Ng·∫Øt k·∫øt n·ªëi</button>
        </div>

        <!-- Main Layout with Users Panel and Chat -->
        <div id="mainLayout" class="main-layout" style="display: none;">
            <!-- Users Panel -->
            <div class="users-panel">
                <div class="users-header">
                    üë• Danh S√°ch Users
                    <span id="userCount" style="float: right; font-size: 0.9rem;">(0)</span>
                </div>
                <div id="usersList" class="users-list">
                    <div style="padding: 20px; text-align: center; color: #666;">
                        ƒêang t·∫£i danh s√°ch users...
                    </div>
                </div>
            </div>

            <!-- Chat Panel -->
            <div class="chat-panel">
                <!-- Chat Header -->
                <div style="background: #007bff; color: white; padding: 15px; border-radius: 8px 8px 0 0; margin-bottom: 0;">
                    <h3 id="chatTitle" style="margin: 0;">üí¨ Ch·ªçn user ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</h3>
                    <p id="chatSubtitle" style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.8;"></p>
                </div>

                <!-- Chat Messages -->
                <div id="chatContainer" class="chat-container" style="border-radius: 0; margin-bottom: 0; border-top: none;">
                    <div style="text-align: center; color: #666; padding: 50px;">
                        Ch·ªçn m·ªôt user t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu chat!
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typingIndicator" class="typing-indicator" style="display: none;"></div>

                <!-- Message Input -->
                <div class="input-group" style="margin-bottom: 0;">
                    <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." disabled />
                    <button id="sendBtn" onclick="sendMessage()" disabled>G·ª≠i</button>
                </div>
            </div>
        </div>

        <!-- Old Chat Room Setup (Hidden when users panel is shown) -->
        <div id="oldChatSetup" class="input-group">
            <input type="number" id="chatId" placeholder="Chat ID..." />
            <button id="joinBtn" onclick="joinChat()" disabled>Join Chat</button>
            <button id="leaveBtn" onclick="leaveChat()" disabled>Leave Chat</button>
        </div>
        
        <!-- Debug Info -->
        <details style="margin-top: 20px;">
            <summary>üîß Debug Info</summary>
            <pre id="debugInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px;"></pre>
        </details>
    </div>

    <!-- SignalR Library -->
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    
    <!-- Chat SignalR Client -->
    <script src="/js/chat-signalr.js"></script>
    
    <script>
        let chatClient = null;
        let currentUserId = null;
        let selectedUser = null;
        let availableUsers = [];
        let currentChatId = null;
        
        // UI Elements
        const statusEl = document.getElementById('status');
        const errorEl = document.getElementById('error');
        const chatContainer = document.getElementById('chatContainer');
        const typingIndicator = document.getElementById('typingIndicator');
        const debugInfo = document.getElementById('debugInfo');
        
        // Buttons
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const sendBtn = document.getElementById('sendBtn');
        
        // Inputs
        const jwtTokenInput = document.getElementById('jwtToken');
        const chatIdInput = document.getElementById('chatId');
        const messageInput = document.getElementById('messageInput');
        
        // Connect to SignalR
        async function connect() {
            const token = jwtTokenInput.value.trim();
            if (!token) {
                showError('Vui l√≤ng nh·∫≠p JWT Token');
                return;
            }
            
            try {
                chatClient = new ChatSignalRClient(token);
                setupCallbacks();
                
                const success = await chatClient.initialize();
                if (success) {
                    updateUI(true);
                    // Extract user ID from JWT (simple decode)
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        currentUserId = parseInt(payload.nameid || payload.sub);
                        updateDebugInfo();

                        // Load available users
                        await loadAvailableUsers(token);
                    } catch (e) {
                        // Could not extract user ID from token
                    }
                }
            } catch (error) {
                showError('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }
        
        // Load available users for chat
        async function loadAvailableUsers(token) {
            try {
                const response = await fetch('/api/chat/available-users', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch users');
                }

                const result = await response.json();

                if (result.status === 200 && result.data) {
                    availableUsers = result.data;
                    displayUsers(result.data);

                    // Show main layout with users panel
                    document.getElementById('mainLayout').style.display = 'grid';
                    document.getElementById('oldChatSetup').style.display = 'none';
                } else {
                    throw new Error(result.message || 'Kh√¥ng c√≥ d·ªØ li·ªáu users');
                }

            } catch (error) {
                showError('L·ªói t·∫£i danh s√°ch users: ' + error.message);
            }
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            const userCount = document.getElementById('userCount');

            if (!users || users.length === 0) {
                usersList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Kh√¥ng c√≥ users n√†o c√≥ th·ªÉ chat</div>';
                userCount.textContent = '(0)';
                return;
            }

            userCount.textContent = `(${users.length})`;

            usersList.innerHTML = users.map(user => `
                <div class="user-item" onclick="selectUser(${user.userId}, '${user.fullName}', '${user.roleName}', ${user.hasExistingChat}, ${user.existingChatId || 'null'})">
                    <div class="user-info">
                        <h4>${user.fullName}</h4>
                        <p>@${user.username} ‚Ä¢ ${user.roleName}</p>
                        <p style="font-size: 11px; color: ${user.hasExistingChat ? '#28a745' : '#6c757d'};">
                            ${user.hasExistingChat ? 'üí¨ ƒê√£ c√≥ chat' : '‚ûï T·∫°o chat m·ªõi'}
                        </p>
                    </div>
                    <div class="user-status ${user.status.toLowerCase()}">
                        ${user.status}
                    </div>
                </div>
            `).join('');
        }

        async function selectUser(userId, fullName, roleName, hasExistingChat, existingChatId) {
       
            document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            selectedUser = { userId, fullName, roleName };

            document.getElementById('chatTitle').textContent = `üí¨ Chat v·ªõi ${fullName}`;
            document.getElementById('chatSubtitle').textContent = `${roleName} ‚Ä¢ ${hasExistingChat ? 'Chat ƒë√£ t·ªìn t·∫°i' : 'Chat m·ªõi'}`;

            clearChat();
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            try {
                if (hasExistingChat && existingChatId) {
                    currentChatId = existingChatId;
                    await loadChatMessages(existingChatId);

                    if (chatClient) {
                        await chatClient.joinChatRoom(existingChatId);
                    }
                } else {
                    await createNewChat(userId);
                }

            } catch (error) {
                showError('L·ªói t·∫£i chat: ' + error.message);
            }
        }

        // Create new chat with selected user
        async function createNewChat(targetUserId) {
            try {
                const response = await fetch('/api/chat/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${document.getElementById('jwtToken').value}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ targetUserId })
                });

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫°o chat m·ªõi');
                }

                const result = await response.json();

                if (result.status === 201 && result.data) {
                    currentChatId = result.data.chatId;

                    // Show empty chat
                    document.getElementById('chatContainer').innerHTML =
                        '<div style="text-align: center; color: #666; padding: 50px;">Chat m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o. H√£y g·ª≠i tin nh·∫Øn ƒë·∫ßu ti√™n!</div>';

                    // Join SignalR room
                    if (chatClient) {
                        await chatClient.joinChatRoom(currentChatId);
                    }

                    // Refresh users list to update status
                    await loadAvailableUsers(document.getElementById('jwtToken').value);
                } else {
                    throw new Error(result.message || 'Kh√¥ng th·ªÉ t·∫°o chat');
                }

            } catch (error) {
                throw error;
            }
        }

        // Load chat messages
        async function loadChatMessages(chatId) {
            try {
                const response = await fetch(`/api/chat/${chatId}/messages?page=1&pageSize=50`, {
                    headers: {
                        'Authorization': `Bearer ${document.getElementById('jwtToken').value}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn');
                }

                const result = await response.json();

                if (result.status === 200 && result.data && result.data.length > 0) {
                    displayChatMessages(result.data.reverse()); // Reverse to show oldest first
                } else {
                    document.getElementById('chatContainer').innerHTML =
                        '<div style="text-align: center; color: #666; padding: 50px;">Ch∆∞a c√≥ tin nh·∫Øn n√†o</div>';
                }

            } catch (error) {
                throw error;
            }
        }

        // Display chat messages
        function displayChatMessages(messages) {
            const chatContainer = document.getElementById('chatContainer');

            chatContainer.innerHTML = messages.map(msg => {
                const isSent = msg.senderId === currentUserId;
                const time = new Date(msg.sentAt).toLocaleTimeString('vi-VN');

                return `
                    <div class="message ${isSent ? 'own' : 'other'}">
                        <div>${msg.content}</div>
                        <div class="message-info">
                            ${isSent ? 'B·∫°n' : msg.senderName} ‚Ä¢ ${time} ${msg.isRead ? '‚Ä¢ ‚úì‚úì' : '‚Ä¢ ‚úì'}
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Disconnect from SignalR
        async function disconnect() {
            if (chatClient) {
                await chatClient.disconnect();
                chatClient = null;
                updateUI(false);
                clearChat();

                // Hide main layout and show old setup
                document.getElementById('mainLayout').style.display = 'none';
                document.getElementById('oldChatSetup').style.display = 'flex';
            }
        }
        
        // Join chat room
        async function joinChat() {
            const chatId = parseInt(chatIdInput.value);
            if (!chatId || !chatClient) return;
            
            const success = await chatClient.joinChatRoom(chatId);
            if (success) {
                joinBtn.disabled = true;
                leaveBtn.disabled = false;
                sendBtn.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
                
                addSystemMessage(`‚úÖ ƒê√£ join chat room ${chatId}`);
                updateDebugInfo();
            }
        }
        
        // Leave chat room
        async function leaveChat() {
            if (chatClient) {
                await chatClient.leaveChatRoom();
                joinBtn.disabled = false;
                leaveBtn.disabled = true;
                sendBtn.disabled = true;
                messageInput.disabled = true;
                
                addSystemMessage('‚¨ÖÔ∏è ƒê√£ r·ªùi kh·ªèi chat room');
                updateDebugInfo();
            }
        }
        
        // Send message
        async function sendMessage() {
            const content = messageInput.value.trim();

            // Use currentChatId if available (from user selection), otherwise fall back to manual input
            const chatId = currentChatId || parseInt(chatIdInput.value);

            if (!content || !chatId || !chatClient) {
                if (!chatId) {
                    showError('Vui l√≤ng ch·ªçn user ƒë·ªÉ chat ho·∫∑c nh·∫≠p Chat ID');
                }
                return;
            }

            const success = await chatClient.sendMessage(chatId, content);
            if (success) {
                messageInput.value = '';
            }
        }
        
        // Setup SignalR callbacks
        function setupCallbacks() {
            chatClient.onNewMessage = (message) => {
                // Only show message if it's for the current chat
                if (currentChatId && message.chatId === currentChatId) {
                    addMessage(message, message.senderId === currentUserId);
                }
                updateDebugInfo();
            };
            
            chatClient.onUserOnline = (userId) => {
                addSystemMessage(`üü¢ User ${userId} ƒë√£ online`);
            };
            
            chatClient.onUserOffline = (userId) => {
                addSystemMessage(`üî¥ User ${userId} ƒë√£ offline`);
            };
            
            chatClient.onTypingIndicator = (data) => {
                if (data.userId !== currentUserId) {
                    showTypingIndicator(data.userId, data.isTyping);
                }
            };
            
            chatClient.onMessagesMarkedAsRead = (data) => {
                addSystemMessage(`üëÅÔ∏è Messages ƒë√£ ƒë∆∞·ª£c ƒë·ªçc b·ªüi User ${data.readByUserId}`);
            };
            
            chatClient.onConnectionStateChanged = (isConnected) => {
                updateConnectionStatus(isConnected);
                updateDebugInfo();
            };
            
            chatClient.onError = (message) => {
                showError(message);
            };
        }
        
        // UI Helper Functions
        function updateUI(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            joinBtn.disabled = !connected;
            jwtTokenInput.disabled = connected;
            
            if (!connected) {
                leaveBtn.disabled = true;
                sendBtn.disabled = true;
                messageInput.disabled = true;
                chatIdInput.disabled = false;
            }
        }
        
        function updateConnectionStatus(isConnected) {
            if (isConnected) {
                statusEl.className = 'status connected';
                statusEl.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi SignalR';
            } else {
                statusEl.className = 'status disconnected';
                statusEl.textContent = '‚ùå M·∫•t k·∫øt n·ªëi SignalR';
            }
        }
        
        function addMessage(message, isOwn) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isOwn ? 'own' : 'other'}`;
            
            const time = new Date(message.sentAt).toLocaleTimeString('vi-VN');
            messageEl.innerHTML = `
                <div>${message.content}</div>
                <div class="message-info">
                    ${message.senderName} ‚Ä¢ ${time} ${message.isRead ? '‚Ä¢ ‚úì‚úì' : '‚Ä¢ ‚úì'}
                </div>
            `;
            
            chatContainer.appendChild(messageEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function addSystemMessage(text) {
            const messageEl = document.createElement('div');
            messageEl.style.textAlign = 'center';
            messageEl.style.color = '#666';
            messageEl.style.fontStyle = 'italic';
            messageEl.style.margin = '10px 0';
            messageEl.textContent = text;
            
            chatContainer.appendChild(messageEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function showTypingIndicator(userId, isTyping) {
            if (isTyping) {
                typingIndicator.textContent = `User ${userId} ƒëang g√µ...`;
                typingIndicator.style.display = 'block';
            } else {
                typingIndicator.style.display = 'none';
            }
        }
        
        function showError(message) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
        
        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            if (selectedUser) {
                chatContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 50px;">ƒêang t·∫£i tin nh·∫Øn...</div>';
            } else {
                chatContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 50px;">Ch·ªçn m·ªôt user t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu chat!</div>';
            }
        }
        
        function updateDebugInfo() {
            if (chatClient) {
                const state = chatClient.getConnectionState();
                debugInfo.textContent = JSON.stringify({
                    connectionState: state,
                    currentUserId: currentUserId,
                    timestamp: new Date().toISOString()
                }, null, 2);
            }
        }
        
        // Enter key to send message
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Typing indicator
        let typingTimer;
        messageInput.addEventListener('input', () => {
            if (chatClient && chatClient.currentChatId) {
                chatClient.sendTypingIndicator(chatClient.currentChatId, true);
                
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    chatClient.sendTypingIndicator(chatClient.currentChatId, false);
                }, 1000);
            }
        });
    </script>
</body>
</html>
